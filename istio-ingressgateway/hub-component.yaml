version: 1
kind: component

requires:
  - kubernetes
  - helm

parameters:
  - name: istio
    parameters:
      - name: version
        value: 1.16.7
        env: HELM_CHART_VERSION
      - name: gateway.autoscaling
        parameters:
          - name: enabled
            value: true
          - name: minReplicas
            value: 1
          - name: maxReplicas
            value: 5
          - name: cpuUtilization
            value: 80

  - name: ingress
    empty: allow
    parameters:
      - name: protocol
        value: http
      - name: class
        empty: allow
      - name: hosts
        env: INGRESS_HOSTS

  - name: kubernetes
    parameters:
      - name: namespace
        value: istio-system
        env: NAMESPACE
      - name: labels
        value: >-
          istio="${hub.componentName}"
          app="${hub.componentName}"
      - name: limits
        value:
          - "cpu: 200m"
          - "memory: 256Mi"
      - name: requests
        value:
          - "cpu: 100m"
          - "memory: 128Mi"
      - name: replicas
        value: 1
      - name: serviceType
        value: ClusterIP

  - name: helm
    parameters:
      - name: chart
        value: gateway
        env: HELM_CHART
      - name: repo
        value: https://istio-release.storage.googleapis.com/charts
        env: HELM_REPO

outputs:
- name: istio.ingressGateway.labels
  value: ${kubernetes.labels}
  brief: |
    Labels to discover the ingress gateway.
    Defined as whitespace separated key=value pairs
    e.g. "app=istio-ingressgateway istio=ingressgateway"

provides:
- istio-ingressgateway

templates:
  kind: go
  files:
    - "*.gotemplate"
