---
version: 1
kind: component

requires:
  - kubernetes

parameters:
# Kubeflow protocol and host
- name: ingress.protocol
- name: ingress.hosts

# Base endpoint of Dex OIDC provider, for example: https://auth.fluffy-cat-21.epam.devops.delivery/
- name: dex.issuer

# OIDC API endpoint, to register used to register OIDC application
- name: dex.api.endpoint

# If authproxy is unable to call the external endpoint of Dex for some reason (e.g. firewall),
# specify the corresponding Kubernetes Service endpoint, e.g. http://dex.dex.svc.cluster.local:5556
# defaults to ${dex.issuer}
- name: dex.issuer.internal
  value: ${dex.issuer}

- name: istio
  parameters:
  - name: namespace
    value: istio-system
    env: NAMESPACE
  - name: ingressGateway
    value: istio-ingressgateway
- name: kubeflow
  parameters:
  - name: version
    value: v1.6.1
    env: VERSION
  - name: authn.oidcProvider
    value: ${dex.issuer}      
  - name: authn.oidcProviderInternal
    value: ${dex.issuer.internal} 
  - name: authn.oidcRedirectURI
    value: ${ingress.protocol}://${ingress.hosts}/login/oidc
  - name: authn.oidcClientId
    value: kubeflow-client
  - name: authn.afterLogin
    value: ${ingress.protocol}://${ingress.hosts}
  - name: authn.oidcSecret
    value: OpenID connect client mutual trust secret between Dex and Kubeflow
  - name: authn.sessionMaxAge
    value: 86400
  - name: authn.volumeSize
    value: 10Gi    
- name: kustomize.tarball.url
  value: "https://github.com/kubeflow/manifests/archive/${kubeflow.version}.tar.gz"
  env: HUB_KUSTOMIZE_TARBALL_URL
- name: kustomize.subpath
  value: common/oidc-authservice
  env: HUB_KUSTOMIZE_TARBALL_SUBPATH

templates:
  files:
  - "*.template"
