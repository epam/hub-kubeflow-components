---
version: 1
kind: component

requires:
  - kubernetes
  - helm

parameters:
  - name: component.ingress
    parameters:
      - name: protocol
        value: https
        env: INGRESS_PROTOCOL
      - name: class
        empty: allow
      - name: ssoUrlPrefix
        value: dex

  - name: dns.domain
    env: HUB_DOMAIN_NAME

  - name: dex
    parameters:
      - name: name
        value: dex
        env: COMPONENT_NAME
      - name: namespace
        value: kube-system
        env: NAMESPACE
      - name: issuerFqdn
        value: auth.${dns.domain}

      - name: helm
        parameters:
          - name: repo
            value: https://charts.dexidp.io
            env: HELM_REPO
          - name: chart
            value: dex
            env: HELM_CHART
          - name: version
            value: 0.9.0
            env: HELM_CHART_VERSION

      - name: image.repo
        value: ghcr.io/dexidp/dex
      - name: image.tag
        value: v2.32.0

      - name: passwordDb
        empty: allow
        parameters:
        - name: email
        - name: password

      - name: connectors
        empty: allow
        parameters:
          - name: ldap
            empty: allow
            parameters:
            - name: host
            - name: dn
            - name: usernamePrompt
              value: Username
            - name: password
            - name: search.dn
            - name: search.usernameAttr
              value: uid
            - name: search.filter
              value: (objectClass=user)
            - name: search.idAttr
              value: uid
            - name: groupSearch.dn
              value: ${dex.connectors.ldap.search.dn}

          - name: okta
            empty: allow
            parameters:
              - name: issuer
              - name: clientId
              - name: clientSecret

outputs:
  - name: dex.api.endpoint
    value: ${dex.name}.${dex.namespace}.svc.cluster.local
  - name: dex.issuer
    value: ${component.ingress.protocol}://${dex.issuerFqdn}

templates:
  extra:
    - kind: go
      files:
        - "*.gotemplate"
